#!/bin/sh
#
# Start execute eMMC download cmd
#
# probe bcm and acm
/etc/run_usb.sh probe bcm
/etc/run_usb.sh probe acm
# start the configfs
/etc/run_usb.sh start

#Create things under /dev
busybox mdev -s
flag=`devmem 0x04000384`
if [ $flag == 0x626D7262 ]; then
  #Clear bmrb flag
  devmem 0x04000384 32 0x0
  /etc/step1.sh
  /usr/bin/image_client
  /etc/step3.sh
  sync
  echo "rebooting"
  reboot -f
elif [ $flag == 0x626D7371 ]; then
  #Clear bmsq flag
  devmem 0x04000384 32 0x0
  /etc/step1_sqsh.sh
  /usr/bin/image_client
  /etc/step3_sqsh.sh
  sync
  echo "rebooting"
  reboot -f
elif [ $flag == 0x626D7462 ]; then
  #Create things under /dev
  busybox mdev -s
  /etc/step1.sh
  echo "downloading....."
  tftp -g -r emmc.tar.gz 192.168.0.200 -l /data/emmc.tar.gz
  /etc/step3.sh
  sync
    #Clear bmtb flag
  devmem 0x04000384 32 0x1
  echo "bmtb rebooting"
  reboot -f
fi
