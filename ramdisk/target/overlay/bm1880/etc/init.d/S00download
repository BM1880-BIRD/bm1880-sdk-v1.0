#!/bin/sh
#
# Start execute eMMC download cmd
#
# probe bcm and acm
/etc/run_usb.sh probe bcm
/etc/run_usb.sh probe acm
# start the configfs
/etc/run_usb.sh start

#Create things under /dev
busybox mdev -s
flag=`devmem 0x04000384`
if [ $flag == 0x626D7262 ]; then
  #Clear bmrb flag
  devmem 0x04000384 32 0x0
  /etc/step1.sh
  /usr/bin/image_client
  /etc/step3.sh
  sync
  echo "rebooting"
  reboot -f
elif [ $flag == 0x626D7371 ]; then
  #Clear bmsq flag
  devmem 0x04000384 32 0x0
  /etc/step1_sqsh.sh
  /usr/bin/image_client
  /etc/step3_sqsh.sh
  sync
  echo "rebooting"
  reboot -f
elif [ $flag == 0x626D7462 ]; then
  #Create things under /dev
  busybox mdev -s
  /etc/step1.sh
  #parse server ip start
  serverip=`devmem 0x04000390`
  IP1=$(($serverip>>24))
  IP1=$(($IP1 & 0XFF))
  IP2=$(($serverip>>16))
  IP2=$(($IP2 & 0XFF))
  IP3=$(($serverip>>8))
  IP3=$(($IP3 & 0XFF))
  IP4=$(($serverip))
  IP4=$(($IP4 & 0XFF))
  parse_server_ip=${IP1}.${IP2}.${IP3}.${IP4}
  echo "parser server ip=${parse_server_ip}"
  #parse board ip start
  serverip=`devmem 0x0400038C`
  IP1=$(($serverip>>24))
  IP1=$(($IP1 & 0XFF))
  IP2=$(($serverip>>16))
  IP2=$(($IP2 & 0XFF))
  IP3=$(($serverip>>8))
  IP3=$(($IP3 & 0XFF))
  IP4=$(($serverip))
  IP4=$(($IP4 & 0XFF))
  parse_board_ip=${IP1}.${IP2}.${IP3}.${IP4}
  echo "parser board ip=${parse_board_ip}"

  ifconfig eth0 ${parse_board_ip}
  echo "downloading....."
  tftp -g -r emmc.tar.gz ${parse_server_ip} -l /data/emmc.tar.gz
  /etc/step3.sh
  sync
    #Clear bmtb flag
  devmem 0x04000384 32 0x1
  echo "bmtb rebooting"
  reboot -f
fi